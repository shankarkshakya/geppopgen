---

---




# Analyses of microsatellite data in R

Hopefully I have covered what microsatellites markers are by this time. Many R packages are available to analyse microsatellite data. We ll be using R package Poppr to analyze the data from [Shakya et al. 2018](https://apsjournals.apsnet.org/doi/10.1094/PDIS-11-17-1801-RE). 

We ll first read the paper and understand what were the objectives of the paper and try to reproduce the work. For this part, We ll work in a group of 3-4 students.


# Download the necessary data

First, we need the microsatellite genotype data which can be downloaded from [here](https://osf.io/hbxvj/files/). Download MX_pop.csv file to your current working directory. 


```{r}

library(poppr)
P.inf <- read.genalex("MX_pop.csv", ploidy = 4)
P.inf

```

## look at the missing data

```{r}
info_table(P.inf, type = "missing", plot = T)
```


Now instead of working with tetraploids lets work with diploid data.

```{r}
multiploid2diploid <- function(x, to = 2){
  
  ploidy_tab <- info_table(x, type = "ploidy")
  mat_sum <- rowSums(ploidy_tab > to, na.rm = TRUE)
  
  diploid_pinf <- x[mat_sum == 0]
  
  diploid_pinf <- recode_polyploids(diploid_pinf, newploidy = to)
  
  return(diploid_pinf)
  
}


diploid_pinf <- multiploid2diploid(P.inf, to = 2)
diploid_pinf

info_table(diploid_pinf, type = "missing", plot = T)

```


## Remove locus with high percentage of missing data

```{r}

diploid_pinf <- missingno(diploid_pinf, type = "loci", cutoff = 0.07)
splitStrata(diploid_pinf) <- ~Region/Year
setPop(diploid_pinf) <- ~Region

diploid_pinf

```

## Table 2. Diversity summary by region 

```{r}
# Corrected simpson diversity index

uSimp <- function(x){
  lambda <- vegan::diversity(x, "simpson")
  x <- drop(as.matrix(x))
  if (length(dim(x)) > 1){
    N <- rowSums(x)
  } else {
    N <- sum(x)
  }
  return((N/(N-1))*lambda)
}


unbiased <- poppr(diploid_pinf, uSimp = uSimp)
unbiased <- unbiased[, c(1,2,3,4,9,10,11)]
colnames(unbiased) <- c("Region", "N", "MLG", "eMLG", "E5", "Corrected lambda", "Hexp")
unbiased <- unbiased[c(6,1,4,3,2,5), ]
rownames(unbiased) <- NULL

unbiased
```

## Table 3. rbarD and Hardy-Weinberg equilibrium

```{r}

ia_Pinf <- poppr(diploid_pinf, clonecorrect = TRUE, strata = ~Region, sample = 999, quiet = TRUE)

ia_Pinf <- ia_Pinf[,c(1:3,13:14)]  
colnames(ia_Pinf) <- c("Region", "N", "MLG", "rbarD", "P-value")
library(pegas)
diploid_pinf_cc <- clonecorrect(diploid_pinf)
hwe_per_pop <- seppop(diploid_pinf_cc) %>% lapply(hw.test, B = 1000)
per_pop_mat <- sapply(hwe_per_pop, "[", i = TRUE, j = 3)
alpha <- 0.05
per_pop_mat[per_pop_mat > alpha] <- 1
library(lattice)
hwe_plot <- levelplot(per_pop_mat, xlab = "Locus", ylab = "Population")
num_loci_hwe <- per_pop_mat
num_loci_hwe[num_loci_hwe != 1] <- 0
num_loci_hwe <- colSums(num_loci_hwe)
ia_Pinf <- ia_Pinf[-7, ]
ia_Pinf <- cbind(ia_Pinf, num_loci_hwe) 
ia_Pinf <- ia_Pinf[c(6,1,4,3,2,5), ]
rownames(ia_Pinf) <- NULL
colnames(ia_Pinf[6]) <- "Number of loci under HWE"

```
